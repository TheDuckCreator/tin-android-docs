<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Room Database - Tin Android Docs</title> <link rel="shortcut icon" href="/tin-android-docs/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/tin-android-docs/assets/css/just-the-docs.css"> <script type="text/javascript" src="/tin-android-docs/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/tin-android-docs/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.6.1 --> <title>Room Database | Tin Android Docs</title> <meta name="generator" content="Jekyll v3.8.5" /> <meta property="og:title" content="Room Database" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="This is the part of Project E-health for Personal Sensor Application (Android Application). I has prepare my android skill for this project, the docs will be in Thai and English" /> <meta property="og:description" content="This is the part of Project E-health for Personal Sensor Application (Android Application). I has prepare my android skill for this project, the docs will be in Thai and English" /> <link rel="canonical" href="/tin-android-docs/AndroidFundamental/RoomDatabaseBasic.html" /> <meta property="og:url" content="/tin-android-docs/AndroidFundamental/RoomDatabaseBasic.html" /> <meta property="og:site_name" content="Tin Android Docs" /> <script type="application/ld+json"> {"@type":"WebPage","url":"/tin-android-docs/AndroidFundamental/RoomDatabaseBasic.html","headline":"Room Database","description":"This is the part of Project E-health for Personal Sensor Application (Android Application). I has prepare my android skill for this project, the docs will be in Thai and English","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="link" viewBox="0 0 16 16"> <title>Link</title> <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path> </symbol> </svg> <div class="page-wrap"> <div class="side-bar"> <div class="site-header"> <a href="/tin-android-docs" class="site-title lh-tight"> Tin Android Docs </a> <button class="menu-button fs-3 js-main-nav-trigger" data-text-toggle="Hide" type="button">Menu</button> </div> <div class="navigation main-nav js-main-nav"> <nav role="navigation" aria-label="Main navigation"> <ul class="navigation-list"><li class="navigation-list-item active"><a href="/tin-android-docs/404.html" class="navigation-list-link"></a></li><li class="navigation-list-item"><a href="/tin-android-docs/AndroidFundamental/BasicKotlin.html" class="navigation-list-link">Basic Kotlin Lang</a></li><li class="navigation-list-item"><a href="/tin-android-docs/Example/BootstrapConectDB.html" class="navigation-list-link">Room DB Connect Example</a></li><li class="navigation-list-item"><a href="/tin-android-docs/AndroidFundamental/Coroutines.html" class="navigation-list-link">Kotlin Coroutines</a></li><li class="navigation-list-item"><a href="/tin-android-docs/AndroidFundamental/DataBinding.html" class="navigation-list-link">DataBinding</a></li><li class="navigation-list-item"><a href="/tin-android-docs/AndroidFundamental/LiveData.html" class="navigation-list-link">LiveData</a></li><li class="navigation-list-item active"><a href="/tin-android-docs/AndroidFundamental/RoomDatabaseBasic.html" class="navigation-list-link active">Room Database</a></li><li class="navigation-list-item"><a href="/tin-android-docs/AndroidFundamental/ViewModel.html" class="navigation-list-link">ViewModel and ViewModel Factory</a></li><li class="navigation-list-item"><a href="/tin-android-docs/about/" class="navigation-list-link">About</a></li><li class="navigation-list-item"><a href="/tin-android-docs/" class="navigation-list-link">Theethawat Android Documents</a></li><hr /> </ul> </nav> </div> <footer class="site-footer"> <p class="text-small text-grey-dk-000 mb-4">This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</p> </footer> </div> <div class="main-content-wrap js-main-content" tabindex="0"> <div class="main-content"> <div class="page-header js-page-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" class="js-search-input search-input" tabindex="0" placeholder="Search Tin Android Docs" aria-label="Search Tin Android Docs" autocomplete="off"> <svg width="14" height="14" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg" class="search-icon"><title>Search</title><g fill-rule="nonzero"><path d="M17.332 20.735c-5.537 0-10-4.6-10-10.247 0-5.646 4.463-10.247 10-10.247 5.536 0 10 4.601 10 10.247s-4.464 10.247-10 10.247zm0-4c3.3 0 6-2.783 6-6.247 0-3.463-2.7-6.247-6-6.247s-6 2.784-6 6.247c0 3.464 2.7 6.247 6 6.247z"/><path d="M11.672 13.791L.192 25.271 3.02 28.1 14.5 16.62z"/></g></svg> </div> <div class="js-search-results search-results-wrap"></div> </div> </div> <div class="page"> <div id="main-content" class="page-content" role="main"> <h1 id="room-database-architecture"> <a href="#room-database-architecture" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Room Database Architecture </h1> <p>การจัดเก็บข้อมูลเป็นสิ่งสำคัญสำหรับทุก ๆ การพัฒนาแอพพลิเคชั่น สำหรับแอนดรอยด์ มันมี By Default อยู่แล้วคือ SQLite Database ซึ่งเป็นฐานข้อมูลแบบ Relational Database วันนี้ผมจะเอาประสบการณ์ที่ผมไปทำใน Code Lab มาอธิบายการทำงานคร่าว ๆ ของ Room Persistance Library หรือ Room Database กัน</p> <h2 id="room-persistance-library"> <a href="#room-persistance-library" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Room Persistance Library </h2> <p>Room Persistance Library จะเป็นตัวสร้าง Database ขึ้นมา เรียกว่า Room Database จากนั้นผู้พัฒนาแอพพลิเคชั่นไม่จำเป็นต้องติดต่อกับฐานข้อมูลโดยตรง แต่จะใช้วิธีการสร้าง Data Access Object หรือ DAO เข้ามาแทน</p> <p>การใช้ Room Database นี้เราสามารถเขียนได้บน Android ทั้งภาษาจาวา และ คอทลิน แต่ที่จะทำนี้จะใช้ภาษา Kotlin เป็นหลักก่อน ที่ผมเขียนเป็นบทความ เพราะเอาไว้โน้ตของผมเองด้วยนะ กลัวจะลืม</p> <p><img src="https://theduckcreator.in.th/assets/android/roomdb.jpg" alt="Room Database Architecure" /></p> <p>หมายเหตุ ที่จะมาเล่านี้อ้างอิงจาก Android with Kotlin Fundamental Course ใน Google Codelab นะครับ สามารถเข้าไปดูและเรียนได้ ฟรี</p> <h2 id="สร้างโปรเจกต์-และจัดการ-buildgradle"> <a href="#สร้างโปรเจกต์-และจัดการ-buildgradle" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> สร้างโปรเจกต์ และจัดการ Build.Gradle </h2> <p>เริ่มจากสร้างโปรเจกต์ใน Android Studio แล้วทำการเพิ่ม dependency ลงไปใน Build.gradle ใน Module “app” การเพิ่ม dependency ลงไป มันก็คล้าย ๆ กับการติดตั้ง Library ต่าง ๆ เหมือนใน Node.js ก็จะมี npm install อันนี้ก็คล้าย ๆ กัน โดยเราจะต้องมา define ก่อนว่า จะเอา roomDB เวอร์ชั่นไหน จะได้เป็นตัวแปล จะได้ไม่ต้องเขียนซ้ำหลายครั้ง</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    dependencies {
        def room_version = "2.2.0"

        //Room Database
        implementation "androidx.room:room-runtime:$room_version"
        annotationProcessor "androidx.room:room-compiler:$room_version"

        //Kotlin Exentension for room
        implementation "androidx.room:room-ktx:$room_version"

        //.....Dependencies อื่น ๆ ....
    }
</code></pre></div></div> <p>ก็จะเป็นการ implementation runtime worker และ annotate ตัวคอมไพเลอร์</p> <h2 id="ไฟล์สำคัญสำหรับการสร้าง-และจัดการ-database"> <a href="#ไฟล์สำคัญสำหรับการสร้าง-และจัดการ-database" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> ไฟล์สำคัญสำหรับการสร้าง และจัดการ Database </h2> <h3 id="1-data-class-เพื่อเตรียมไว้ใช้ในการสร้าง-table"> <a href="#1-data-class-เพื่อเตรียมไว้ใช้ในการสร้าง-table" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> 1. Data Class เพื่อเตรียมไว้ใช้ในการสร้าง Table </h3> <h4 id="เตรียมสร้าง-data-class"> <a href="#เตรียมสร้าง-data-class" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> เตรียมสร้าง Data Class </h4> <p>เริ่มจากสร้างไฟล์ Kotlin (.kt) เปล่า ๆ มาตัวหนึ่ง แล้วเราก็มีตัวแปล หรือ Entity ต่าง ๆ อยู่ในสมอง เราสามารถตั้งชื่อไฟล์นี้ แทนชื่อตารางแบบง่าย ๆ ก็ได้ เช่นผมตั้งว่า <code class="language-plaintext highlighter-rouge">SleepNight.kt</code> เราทราบอยู่แล้วว่าในภาษา Kotlin นั้นชื่อไฟล์กับชื่อคลาส ไม่จำเป็นต้องตรงกันก็ได้ ไม่เหมือนใน Java แต่ว่า ตรงกันไว้ก็ดี จากนั้น เราก็เริ่มทำการ Implement dataclass โดยใส่ตัวแปล ที่เราต้องการให้มันเป็น column ใน Database ลงไป</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    data class SleepNight(
        var nightId: Long = 0L,
        val startTimeMilli:Long = System.currentTimeMillis(),
        var endtimeMilli: Long = startTimeMilli,
        var sleepQuality: Int = -1
    )
</code></pre></div></div> <p>Initial ค่าไปเลยก็ดี จะเห็นว่า data class ใน Kotlin นั้น เราใส่ตัวแปลลงในส่วนของพารามิเตอร์รับค่าเลย data class ในความคิดของผม ผมมองว่าคล้าย ๆ เราสร้าง Stucture ในภาษา C หรือ อื่น ๆ</p> <h4 id="บอกกับแอนดรอยด์ให้รู้ว่าส่วนนี้ของ-data-class-คือส่วนใดของ-table-ใน-database"> <a href="#บอกกับแอนดรอยด์ให้รู้ว่าส่วนนี้ของ-data-class-คือส่วนใดของ-table-ใน-database" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> บอกกับแอนดรอยด์ให้รู้ว่าส่วนนี้ของ Data Class คือส่วนใดของ Table ใน Database </h4> <p>เราจะต้อง define บอกมันให้รู้ว่าส่วนตรงนี้คืออะไร เช่น Attribute นี้เป็น Primary Key หรืออะไรต่าง ๆ เป็นต้น</p> <ul> <li> <p>data class ของเราเป็น entity set หรือ เป็นตารางนั้นเอง เราต้องบอกให้มันรู้ว่ามันเป็นตาราง โดยการเขียนไว้ข้างหน้าว่า</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  @Entity(tableName = "daily_sleep_quality_table")
  data class SleepNight { .... }
</code></pre></div> </div> </li> <li> <p>กำหนด Primary Key โดย เราจะบอกว่า ตัวนี้เป็น primary key หน้าตัวแปลของเรา แล้วเราจะใส่ Attribute ควบคุมต่าง ๆ ข้างในวงเล็บ เช่นในตัวอย่างนี้เป็น <code class="language-plaintext highlighter-rouge">autoGenerate = true</code></p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  @PrimaryKey(autoGenerate = true)
  var nightId:Long = 0L,
</code></pre></div> </div> </li> <li> <p>กำหนด ColumnInfo ให้กับตัวคอลัมม์อื่น ๆ ที่ไม่ใช่ Primary Key โดยใช้แทก <code class="language-plaintext highlighter-rouge">@ColumnInfo</code></p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    @ColumnInfo(name="start_time_milli")
    val startTimeMilli:Long = System.currentTimeMillis(),
</code></pre></div> </div> <p>อย่างน้อยที่สุดก็คือ ใส่ชื่อให้มัน</p> </li> </ul> <p>จะสังเกตุว่าตัวแปลต่าง ๆ ที่เขียนใน Java, Kotlin เราจะเขียนเป็น Camel Case อยู่แล้ว แต่ถ้ามันไปอยู่ในมุมของ Physical หรือ ในมุมที่มันจะไปสร้างใน Database เรามักจะเขียนกลับไปเป็นแบบเดิม เช่นมี Underscore หรือ อะไรต่าง ๆ คล้าย ๆ กับภาษา C หรือ รักษา SQL เอาไว้ เพราะมันอาจจะ Implement ได้ง่านกว่า ในตรงนั้น</p> <p>เมื่อถึงขั้นตอนนี้ โค้ดทั้งหมด ก็จะเป็นประมาณนี้</p> <script src="https://gist.github.com/theethawat/f8b4840225756d51540495ab3d50cdb3.js?file=SleepNight.kt"></script> <h3 id="2-สร้าง-data-access-object-dao"> <a href="#2-สร้าง-data-access-object-dao" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> 2. สร้าง Data Access Object (Dao) </h3> <p>ตรงนี้คือการสร้างฟังก์ชั่น ขึ้นมา Reference คอมมานด์ หรือ ที่เราเรียกว่า Queries ต่าง ๆ ใน Relational Database นั่นเอง กล่าวคือ Data Access Object จะช่วยให้เราไม่ต้องเขียน Query ยาว ๆ เพียงแต่เรียกเป็นฟังก์ชันสั้น ๆ แค่นั้นเอง โดย Data Access Object จะสร้างอยู่ในรูปแบบของ Interface</p> <p>ถ้าตามหลักของ OOP Interface คือ โครงสร้างของ Class อันนี้ก็เช่นเดียวกัน คือ มีความสามารถ มี Method อะไรบ้าง Return ค่ามั้ย ถ้า Return จะกลับมาเป็นอะไร รับค่ามั้ย เราจะให้พารามิเตอร์มันชื่ออะไร เป็นลักษณะแบบไหน Int, Float, Char หรือ เป็น User Define Type อย่างที่เราทำ Class, Data Class เราใส่ไปให้หมด โดยไม่ต้อง Implement Method (ที่ Kotlin เรียก fun ) ข้างใน</p> <h4 id="interface-feature-listing"> <a href="#interface-feature-listing" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Interface Feature Listing </h4> <p>ต้องการฟีเจอร์ หรือ Queries อะไรกับ Database บ้าง ลองลิสต์ลงมาก่อนเลย โดยชื่อไฟล์ยังเป็นไฟล์ .kt เหมือนเดิม แต่นิยมตั้งเป็น Dao ตามหลังเช่น <code class="language-plaintext highlighter-rouge">SleepDatabaseDao.kt</code> เป็นต้น</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    interface SleepDatabaseDao{
        fun insert(night:SleepNight)
        fun update(night:SleepNight)
        fun clear()
        fun get(key:Long):SleepNight?
        fun getTonight():SleepNight?
        fun getAllNight():LiveData&lt;List&lt;SleepNight&gt;&gt;
    }
</code></pre></div></div> <h4 id="บอกให้มันรู้ว่าตรงนี้-เป็นส่วนใดของ-query-เป็นส่วนใดของ-database"> <a href="#บอกให้มันรู้ว่าตรงนี้-เป็นส่วนใดของ-query-เป็นส่วนใดของ-database" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> บอกให้มันรู้ว่าตรงนี้ เป็นส่วนใดของ Query เป็นส่วนใดของ Database </h4> <p>เหมือนอย่างในขั้นตอนที่แล้ว เราก็จะมี Annotate หน้า Class หรือ Function ตอนนี้ก็เช่นกัน</p> <ul> <li> <p>กำหนดว่า interface นี้ เป็น Data Access Object (Dao) นะ เราก็ใส่ <code class="language-plaintext highlighter-rouge">@Dao</code> ไปข้างบน Interface</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  @Dao
  interface SleepDatabaseDao ( ...)
</code></pre></div> </div> </li> <li> <p>การใส่ Query ให้มัน ให้ถูกต้อง ใช่เนื่องจากมันเป็น Interface เราจะไปสั่งอะไรใน Function / Method มันหละ เราจะใช้วิธีนี้ในการบอกมันก่อนเลยว่า เออ เจอคนสั่งฟังก์ชันนี้มาทำยังไง มีด้วยกัน 2 แบบ คือ ใช้ Query สามัญ ๆ ที่มันมีไว้ให้แล้ว กับเขียน Query ขึ้นเอง เริ่มด้วยสามัญ ๆ</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  @insert
  fun insert(night:SleepNight)
</code></pre></div> </div> <p>ต่อไปมาดูคิวรี่ที่เราสามารถเขียนไปเองได้ โดยเราเองสามารถเอาตัวแปล ที่เราประกาศเป็นตัวรับค่าในฟังก์ชันนั้น มาใช้ได้ โดยใช้เครื่องหมาย : นำหน้าชื่อตัวแปล เช่น <code class="language-plaintext highlighter-rouge">:key</code></p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  @Query("SELECT * FROM daily_sleep_quality_table WHERE nightId = :key ")
  fun get(key:Long):SleepNighit?
</code></pre></div> </div> </li> </ul> <p>โดยสามารถใช้ SQL Command ต่าง ๆ ได้อยู่แล้ว ถึงตอนนี้ของผมจะได้โค้ดประมาณนี้ แล้วเดี๋ยวเราจะมาสร้าง Database ลงในมือถือของเรากัน</p> <script src="https://gist.github.com/theethawat/f8b4840225756d51540495ab3d50cdb3.js?file=SleepDatabaseDao.kt"></script> <h3 id="3-การเอา-database-ไปสร้างขึ้นอยู่บนอุปกรณ์แอนดรอยด์"> <a href="#3-การเอา-database-ไปสร้างขึ้นอยู่บนอุปกรณ์แอนดรอยด์" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> 3. การเอา Database ไปสร้างขึ้นอยู่บนอุปกรณ์แอนดรอยด์ </h3> <p>หลังจากเราวางโครงสร้างของ Database เรียบร้อยแล้ว แต่เรายังไม่สร้าง เราก็จะไปกำหนดคอนฟิก ให้มันสร้าง Database ขึ้นมา คือมันไม่จำเป็นที่จะต้องสร้าง Data base ใหม่ทุกครั้ง ไม่นั้นเครื่อง Client คงความจำเต็มตายเลย</p> <h4 id="abstract-class-creation"> <a href="#abstract-class-creation" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Abstract Class Creation </h4> <p>ต่อมาเราจะสร้าง Database โดยการสร้าง Abstract Class ซึ่ง Abstract Class ใน OOP คือ Class ที่ไม่สามารถสร้าง Object ได้โดยตรง แต่สามารถให้มีการถ่ายทอดไปยัง Class ลูกก่อน แล้ว Class ลูกก็จะ Implement Abstract Method จากนั้น ก็จัดการได้เลย ใน Abstract Class จะมีอย่างน้อย 1 Abstract Method ที่ว่าง ๆ เลย ให้ Class ลูก ไปจัดการ Implement เอาเอง และ Method อื่น ๆ เราสามารถเขียนต่าง ๆ ลงใน Method ได้เลย ว่าจะให้ Method นี้ทำงานอะไร ซึ่งตรงนี้เองที่ทำให้ Abstract Class แตกต่างจาก Interface</p> <p>ดังนั้นเราจะมาเริ่มสร้าง Database ของเราโดยเริ่มจากสร้าง Class ที่ extend RoomDatabase</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    abstract class SleepDatabase:RoomDatabase(){
        ...
    }
</code></pre></div></div> <h4 id="implement-database-class"> <a href="#implement-database-class" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Implement Database Class </h4> <p>หลังจากนั้นก็จะมีขั้นตอนต่าง ๆ ใน การ Implement Database ของเราดังนี้</p> <ul> <li> <p>บอกว่า Class นี้คือ Database แน่นอนว่าเราจำเป็นที่จะต้อง Annotate เหมือนทุก ๆ อันที่ผ่านมา โดยครั้งนี้เราต้อง <strong>บอก</strong> ด้วยว่าเราจะสร้างจาก Class อะไร (ซึ่งก็คือ Class นี้) มี Properties อะไรบ้าง โดยใช้ <code class="language-plaintext highlighter-rouge">@Database(entities = [...] , version = ... , exportSchema = ...</code> ดังนี้</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  @Database(entities = [SleepDatabase::class],version = 1 ,exportSchema = false)
  abstract class SleepDatabase:RoomDatabase(){

  }
</code></pre></div> </div> </li> <li> <p>เอา Data Access Object หรือแหล่งรวม Query ในรูปแบบกำหนดเป็นชื่อฟังก์ชันของเรามาใส่ โดยเราต้องใส่ในรูปแบบของ Abstract Variable ก็ถ้า Abstract Class ไม่มีอะไรเป็น Abstract แล้วเราจะสร้างมันเป็น Abstract ทำไมหละ</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  abstract val sleepDatabaseDao:SleepDatabaseDao
</code></pre></div> </div> </li> <li> <p>สร้าง Companion Object มาใช้ในการให้ไฟล์อื่น ๆ สามารถเจ้าถึง Database หรือ จะ Initial Database ได้ โดยที่ไม่ต้องไปสร้างเป็นตัวอย่าง หรือ เป็น Instance เอง คือผมพูดถูกมั้ย คือเราสร้าง Instance ไปเลย และให่เขาเรียกใช้ได่เลย ไม่ต้องมาสร้าง Instance เองอยู่</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  companion object{

  }
</code></pre></div> </div> </li> <li> <p>สร้างตัวแปรตัวอย่างของเรา หรือ INSTANCE ของเราขึ้นมา อย่างที่บอกไว้คือ ตัวลูก ไม่ต้องสร้างเอง เราสร้างไว้ตรงนี้เลย โดยตัวแปลของ INSTANCE ของเราจะเป็นชนิด <code class="language-plaintext highlighter-rouge">SleepDatabase</code> ก็คือ เรากำลังสร้าง Database ที่มี Table SleepDatabase ที่เราเขียนโครงสร้างของตารางมาแล้วด้านบน</p> <p>โดยเราจะมีการกำหนดนิดนึงว่า ตัวแปลรัวนี้จะเป็นตัวแปรรูปแบบ <code class="language-plaintext highlighter-rouge">@Volatile</code> คือ เราจะไม่ขออยู่ใน Cache ขออยู่ใน Memory ไปเลย จะทำให้ ตัวแปร INSTANCE หรือ ตัวแปรแทนโครงสร้างตารางเนี่ย ไม่อยู่ใน Cache เราจะได้ไม่ต้องกลัวปัญหาว่า มันจะตรงกันหรือเปล่า ใน Cache กับ ใน RAM เรายอมอาจจะช้าลงนิดนึง แต่ชั่วร์</p> <p>โดยเราจะสร้างตัวแปรเป็น <code class="language-plaintext highlighter-rouge">Nullable</code> และ ตั้งค่าเริ่มต้นเป็น <code class="language-plaintext highlighter-rouge">null</code> และเป็นตัวแปรแบบเปลี่ยนค่าได้</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  private var INSTANCE : SleepDatabase? = null
</code></pre></div> </div> <p>ที่เราตั้งเป็น Null ก็เพราะว่า โอเค ตอนนี้ INSTANCE เทียบได้กับDatabase ที่เราจะสร้างแล้ว แต่ว่า เราจะยังไม่สร้าง เราจะตรวจสอบก่อนว่าตอนนี้ มันมีอยู่แล้ว หรือ ไม่ อย่าลืมว่า เราอาจจะไม่ได้ build หรือ Install / Run App นี้ครั้งเดียว ในระหว่าง การพัฒนา ดังนั้น เราจะเช็คก่อนว่า Database มีอยู่แล้วหรือไม่ ถ้ามีก็ไม่ต้องสร้าง ถ้าไม่มี ก็สร้าง จะได้ไม่ซับซ้อนด้วย</p> </li> <li> <p>Synchronyze Program แล้วดูว่า instance ของเรามีอยู่หรือไม่ เราจะใช้การ Smart Cast สร้างตัวแปลใน loop ไม่สิ ใน Function นี้อีกตัว เป็นการ Copy มาจะได้ไม่มีปัญหาค่าซ้ำซ้อนของตัวแปร แล้วค่อยส่งค่ากลับไป</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  synchronized(this){
      var instance = INSTANCE

      ...

      return instance
  }
</code></pre></div> </div> </li> <li> <p>เช็คว่า Database ถูกสร้างแล้วหรือยัง ข้างต้นนี้ คือ Database ถูกสร้างแล้ว Return มันกลับไปเลย แต่ถ้า instance เป็น null เราจะสร้าง Database มันขึ้นมา โดยสิ่งต่อไปนี้ยังอยู่ใน Scope ของ <code class="language-plaintext highlighter-rouge">synchronized(this){ }</code> นะ ก่อน <code class="language-plaintext highlighter-rouge">return</code> ด้วย</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  if(instance == null){
      instance = Room.databaseBuilder(
          context.applicationContext,
          SleepDatabase::class.java,
          "sleep_history_database"
      ).fallbackToDestructiveMigration().build()
  }
</code></pre></div> </div> <p>ดูจากโค้ดเราก็จะพบว่า เราจะสร้าง instance ให้เป็นค่าใดค่าหนึ่ง นั่นก็คือ เป็น Room และเรียกใช้ DatabaseBuilder โดยยึดจาก Class SleepDatabase ก็คือ Class นี้ และใช้ชื่อ <code class="language-plaintext highlighter-rouge">sleep_history_database</code> จากนั้นจึงสั่ง <code class="language-plaintext highlighter-rouge">fallbackToDestructiveMigration()</code> และ <code class="language-plaintext highlighter-rouge">build()</code> ก่อนจะ Return ออกไป เป็น Instance</p> </li> </ul> <p>จากขั้นตอนทั้งหมด ของส่วนที่ 3 นี้ จะมี Source Code ทั้งหมดเป็นดังนี้</p> <script src="https://gist.github.com/theethawat/f8b4840225756d51540495ab3d50cdb3.js?file=SleepDatabase.kt"></script> <p>ทั้งหมดนี้ ก็คือการสร้าง Database เริ่มต้นในโปรแกรมของเรา โดยสร้างผ่าน Room Database บน Android ตรงนี้ยังไม่พูดถึงการใช้ UI จากฝั่งผู้ใช้มา Connect หรือ Interact กับโปรแกรมของเรา ซึ่งตรงนี้เราก็อาจจะไปดีไซด์ Layout แล้ว ใช้รูปแบบต่าง ๆ ในการ Map View ของเรา เข้ากับ Model ของเราตรงนี้ ได้ ไม่ว่าจะเป็น Model View Controller (MVC), Model View Presenter (MVP) หรือ Model View ViewModel (MVVM) ก็ได้</p> </div> </div> </div> </div> </body> </html>
